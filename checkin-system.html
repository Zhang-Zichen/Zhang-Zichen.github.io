<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>签到系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5;
      }
      .form-input-focus {
        @apply focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 全局状态管理 -->
  <script>
    // 模拟数据库
    const db = {
      users: [
        { id: 1, username: 'admin', password: 'Admin123', name: '管理员', points: 0, isAdmin: true, status: 'approved' },
        { id: 2, username: 'user1', password: 'User123', name: '张三', points: 100, isAdmin: false, status: 'approved' },
        { id: 3, username: 'user2', password: 'User456', name: '李四', points: 50, isAdmin: false, status: 'approved' }
      ],
      registrationRequests: [], // 注册请求表
      products: [
        { id: 1, name: '保温杯', points: 50, quantity: 10, description: '304不锈钢真空保温杯，保温时长12小时以上。' },
        { id: 2, name: '充电宝', points: 80, quantity: 5, description: '20000mAh大容量充电宝，支持快充。' },
        { id: 3, name: '蓝牙音箱', points: 120, quantity: 3, description: '高品质蓝牙音箱，360°环绕立体声。' },
        { id: 4, name: '无线耳机', points: 150, quantity: 0, description: '主动降噪无线耳机，续航30小时。' }
      ],
      checkins: [
        { userId: 2, date: '2025-07-20' },
        { userId: 3, date: '2025-07-21' }
      ],
      passwordRequests: [],
      usernameRequests: [], // 新增用户名修改请求表
      exchangeRequests: [],
      pointsTransactions: [] // 积分交易记录
    };

    // 全局状态
    const state = {
      currentUser: null,
      currentPage: 'login',
      currentProduct: null,
      currentUserForPoints: null, // 当前要操作积分的用户
      passwordRequest: { name: '', newPassword: '', confirmPassword: '' },
      usernameRequest: { newUsername: '', password: '' }, // 新增用户名修改请求状态
      productForm: { id: null, name: '', points: '', quantity: '', description: '' }
    };

    // 工具函数
    function saveDB() {
      localStorage.setItem('checkInSystemDB', JSON.stringify(db));
    }

    function loadDB() {
      const savedDB = localStorage.getItem('checkInSystemDB');
      if (savedDB) {
        Object.assign(db, JSON.parse(savedDB));
      }
    }

    function validatePassword(password) {
      return /^[A-Za-z0-9]+$/.test(password);
    }

    function validateUsername(username) {
      return /^[A-Za-z0-9]+$/.test(username);
    }

    function validateChineseName(name) {
      return /^[\u4e00-\u9fa5]+$/.test(name);
    }

    function formatDate(date) {
      const d = new Date(date);
      return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
    }

    function hasCheckedInToday(userId) {
      const today = formatDate(new Date());
      return db.checkins.some(checkin => checkin.userId === userId && checkin.date === today);
    }

    // 页面导航
    function navigateTo(page) {
      state.currentPage = page;
      render();
    }

    // 用户认证
    function handleRegister() {
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-confirm-password').value;
      const name = document.getElementById('register-name').value.trim();

      if (!username || !password || !confirmPassword || !name) {
        showToast('请填写所有字段', 'error');
        return;
      }

      if (!validateUsername(username)) {
        showToast('用户名只能包含大小写字母和数字', 'error');
        return;
      }

      if (db.users.some(user => user.username === username) || 
          db.registrationRequests.some(req => req.username === username) ||
          db.usernameRequests.some(req => req.newUsername === username)) {
        showToast('用户名已存在或正在审核中', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showToast('两次输入的密码不一致', 'error');
        return;
      }

      if (!validatePassword(password)) {
        showToast('密码只能包含大小写字母和数字', 'error');
        return;
      }

      if (!validateChineseName(name)) {
        showToast('请输入真实中文姓名', 'error');
        return;
      }

      const newRequest = {
        id: db.registrationRequests.length > 0 ? Math.max(...db.registrationRequests.map(req => req.id)) + 1 : 1,
        username,
        password,
        name,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      db.registrationRequests.push(newRequest);
      saveDB();
      showToast('注册请求已提交，请等待管理员审核', 'success');
      navigateTo('login');
    }

    function handleLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      if (!username || !password) {
        showToast('请填写用户名和密码', 'error');
        return;
      }

      const user = db.users.find(user => user.username === username && user.password === password);

      if (!user) {
        // 检查是否有未审核的注册请求
        const pendingRequest = db.registrationRequests.find(
          req => req.username === username && req.status === 'pending'
        );
        if (pendingRequest) {
          showToast('您的账号正在审核中，请耐心等待', 'info');
        } else {
          showToast('用户名或密码错误', 'error');
        }
        return;
      }

      if (user.status !== 'approved') {
        showToast('您的账号正在审核中或已被拒绝', 'error');
        return;
      }

      state.currentUser = user;
      saveDB();
      navigateTo(user.isAdmin ? 'adminDashboard' : 'userDashboard');
    }

    function handleAdminLogin() {
      const username = document.getElementById('admin-username').value.trim();
      const password = document.getElementById('admin-password').value;

      if (!username || !password) {
        showToast('请填写用户名和密码', 'error');
        return;
      }

      const admin = db.users.find(user => user.username === username && user.password === password && user.isAdmin);

      if (!admin) {
        showToast('管理员账号或密码错误', 'error');
        return;
      }

      state.currentUser = admin;
      saveDB();
      navigateTo('adminDashboard');
    }

    // 密码修改功能
    function handleUserChangePassword() {
      const oldPassword = document.getElementById('old-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        showToast('请填写所有字段', 'error');
        return;
      }

      // 验证旧密码是否正确
      if (state.currentUser.password !== oldPassword) {
        showToast('旧密码不正确', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast('两次输入的新密码不一致', 'error');
        return;
      }

      if (!validatePassword(newPassword)) {
        showToast('密码只能包含大小写字母和数字', 'error');
        return;
      }

      const request = {
        id: db.passwordRequests.length > 0 ? Math.max(...db.passwordRequests.map(req => req.id)) + 1 : 1,
        userId: state.currentUser.id,
        username: state.currentUser.username,
        newPassword,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      db.passwordRequests.push(request);
      saveDB();
      showToast('密码修改请求已提交，请等待管理员审核', 'success');
      navigateTo('userDashboard');
    }

    // 新增：普通用户修改用户名功能
    function handleUserChangeUsername() {
      const newUsername = document.getElementById('new-username').value.trim();
      const password = document.getElementById('username-password').value;

      if (!newUsername || !password) {
        showToast('请填写所有字段', 'error');
        return;
      }

      // 验证密码是否正确
      if (state.currentUser.password !== password) {
        showToast('密码不正确', 'error');
        return;
      }

      if (!validateUsername(newUsername)) {
        showToast('用户名只能包含大小写字母和数字', 'error');
        return;
      }

      // 检查用户名是否已存在或正在审核中
      if (db.users.some(user => user.username === newUsername) ||
          db.usernameRequests.some(req => req.newUsername === newUsername && req.status === 'pending')) {
        showToast('用户名已存在或正在审核中', 'error');
        return;
      }

      // 如果用户名没有变化
      if (newUsername === state.currentUser.username) {
        showToast('新用户名与当前用户名相同', 'error');
        return;
      }

      const request = {
        id: db.usernameRequests.length > 0 ? Math.max(...db.usernameRequests.map(req => req.id)) + 1 : 1,
        userId: state.currentUser.id,
        oldUsername: state.currentUser.username,
        newUsername,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      db.usernameRequests.push(request);
      saveDB();
      showToast('用户名修改请求已提交，请等待管理员审核', 'success');
      navigateTo('userDashboard');
    }

    function handleAdminChangePassword() {
      const oldPassword = document.getElementById('admin-old-password').value;
      const newPassword = document.getElementById('admin-new-password').value;
      const confirmPassword = document.getElementById('admin-confirm-password').value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        showToast('请填写所有字段', 'error');
        return;
      }

      // 验证旧密码是否正确
      if (state.currentUser.password !== oldPassword) {
        showToast('旧密码不正确', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast('两次输入的新密码不一致', 'error');
        return;
      }

      if (!validatePassword(newPassword)) {
        showToast('密码只能包含大小写字母和数字', 'error');
        return;
      }

      const userIndex = db.users.findIndex(user => user.id === state.currentUser.id);
      if (userIndex !== -1) {
        db.users[userIndex].password = newPassword;
        state.currentUser.password = newPassword;
      }

      saveDB();
      showToast('密码已成功修改', 'success');
      navigateTo('adminDashboard');
    }

    // 管理员修改用户名功能
    function handleAdminChangeUsername() {
      const newUsername = document.getElementById('admin-new-username').value.trim();
      const password = document.getElementById('admin-username-password').value;

      if (!newUsername || !password) {
        showToast('请填写所有字段', 'error');
        return;
      }

      // 验证密码是否正确
      if (state.currentUser.password !== password) {
        showToast('密码不正确', 'error');
        return;
      }

      if (!validateUsername(newUsername)) {
        showToast('用户名只能包含大小写字母和数字', 'error');
        return;
      }

      // 检查用户名是否已存在
      if (db.users.some(user => user.id !== state.currentUser.id && user.username === newUsername)) {
        showToast('用户名已存在', 'error');
        return;
      }

      // 更新用户名
      const userIndex = db.users.findIndex(user => user.id === state.currentUser.id);
      if (userIndex !== -1) {
        db.users[userIndex].username = newUsername;
        state.currentUser.username = newUsername;
      }

      saveDB();
      showToast('用户名已成功修改', 'success');
      navigateTo('adminDashboard');
    }

    // 新增：管理员处理用户名修改请求
    function handleAdminApproveUsername(requestId) {
      const requestIndex = db.usernameRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      const request = db.usernameRequests[requestIndex];
      const userIndex = db.users.findIndex(user => user.id === request.userId);

      if (userIndex !== -1) {
        db.users[userIndex].username = request.newUsername;
        // 如果是当前登录用户，更新状态中的用户名
        if (state.currentUser && state.currentUser.id === request.userId) {
          state.currentUser.username = request.newUsername;
        }
      }

      db.usernameRequests[requestIndex].status = 'approved';
      saveDB();
      showToast('用户名修改已批准', 'success');
      render();
    }

    function handleAdminRejectUsername(requestId) {
      const requestIndex = db.usernameRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      db.usernameRequests[requestIndex].status = 'rejected';
      saveDB();
      showToast('用户名修改已拒绝', 'success');
      render();
    }

    // 管理员处理注册请求
    function handleAdminApproveRegistration(requestId) {
      const requestIndex = db.registrationRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      const request = db.registrationRequests[requestIndex];
      
      const newUser = {
        id: db.users.length > 0 ? Math.max(...db.users.map(user => user.id)) + 1 : 1,
        username: request.username,
        password: request.password,
        name: request.name,
        points: 0,
        isAdmin: false,
        status: 'approved'
      };

      db.users.push(newUser);
      db.registrationRequests[requestIndex].status = 'approved';
      saveDB();
      showToast('注册已批准', 'success');
      render();
    }

    function handleAdminRejectRegistration(requestId) {
      const requestIndex = db.registrationRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      db.registrationRequests[requestIndex].status = 'rejected';
      saveDB();
      showToast('注册已拒绝', 'success');
      render();
    }

    // 管理员处理密码修改请求
    function handleAdminApprovePassword(requestId) {
      const requestIndex = db.passwordRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      const request = db.passwordRequests[requestIndex];
      const userIndex = db.users.findIndex(user => user.id === request.userId);

      if (userIndex !== -1) {
        db.users[userIndex].password = request.newPassword;
        // 如果是当前登录用户，更新状态中的密码
        if (state.currentUser && state.currentUser.id === request.userId) {
          state.currentUser.password = request.newPassword;
        }
      }

      db.passwordRequests[requestIndex].status = 'approved';
      saveDB();
      showToast('密码修改已批准', 'success');
      render();
    }

    function handleAdminRejectPassword(requestId) {
      const requestIndex = db.passwordRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      db.passwordRequests[requestIndex].status = 'rejected';
      saveDB();
      showToast('密码修改已拒绝', 'success');
      render();
    }

    // 签到功能
    function handleCheckIn() {
      if (!state.currentUser) return;

      if (hasCheckedInToday(state.currentUser.id)) {
        showToast('今天已经签到过了', 'info');
        return;
      }

      db.checkins.push({
        userId: state.currentUser.id,
        date: formatDate(new Date())
      });

      const userIndex = db.users.findIndex(user => user.id === state.currentUser.id);
      if (userIndex !== -1) {
        db.users[userIndex].points += 10;
        state.currentUser.points += 10;
      }

      // 记录积分交易
      db.pointsTransactions.push({
        id: db.pointsTransactions.length > 0 ? Math.max(...db.pointsTransactions.map(t => t.id)) + 1 : 1,
        userId: state.currentUser.id,
        type: 'checkin',
        points: 10,
        date: new Date().toISOString(),
        operator: 'system'
      });

      saveDB();
      showToast('签到成功，获得10积分', 'success');
      render();
    }

    // 商品管理
    function handleExchangeProduct(productId) {
      if (!state.currentUser) {
        showToast('请先登录', 'error');
        navigateTo('login');
        return;
      }

      const product = db.products.find(p => p.id === productId);
      if (!product) return;

      if (product.quantity <= 0) {
        showToast('商品库存不足', 'error');
        return;
      }

      if (state.currentUser.points < product.points) {
        showToast('积分不足', 'error');
        return;
      }

      const request = {
        id: db.exchangeRequests.length > 0 ? Math.max(...db.exchangeRequests.map(req => req.id)) + 1 : 1,
        userId: state.currentUser.id,
        productId: product.id,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      db.exchangeRequests.push(request);
      saveDB();
      showToast('兑换请求已提交，请等待管理员审核', 'success');
      navigateTo('productList');
    }

    function handleAdminApproveExchange(requestId) {
      const requestIndex = db.exchangeRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      const request = db.exchangeRequests[requestIndex];
      const productIndex = db.products.findIndex(p => p.id === request.productId);
      const userIndex = db.users.findIndex(user => user.id === request.userId);

      if (productIndex !== -1 && userIndex !== -1) {
        const product = db.products[productIndex];
        if (product.quantity > 0) {
          db.products[productIndex].quantity -= 1;
          db.users[userIndex].points -= product.points;
          db.exchangeRequests[requestIndex].status = 'approved';
          
          // 记录积分交易
          db.pointsTransactions.push({
            id: db.pointsTransactions.length > 0 ? Math.max(...db.pointsTransactions.map(t => t.id)) + 1 : 1,
            userId: request.userId,
            type: 'exchange',
            points: -product.points,
            date: new Date().toISOString(),
            operator: state.currentUser.username
          });
          
          saveDB();
          showToast('兑换已批准', 'success');
        } else {
          showToast('商品库存不足', 'error');
          db.exchangeRequests[requestIndex].status = 'rejected';
          saveDB();
        }
      }

      render();
    }

    function handleAdminRejectExchange(requestId) {
      const requestIndex = db.exchangeRequests.findIndex(req => req.id === requestId);
      if (requestIndex === -1) return;

      db.exchangeRequests[requestIndex].status = 'rejected';
      saveDB();
      showToast('兑换已拒绝', 'success');
      render();
    }

    function handleAdminAddProduct() {
      const name = document.getElementById('admin-product-name').value.trim();
      const points = parseInt(document.getElementById('admin-product-points').value, 10);
      const quantity = parseInt(document.getElementById('admin-product-quantity').value, 10);
      const description = document.getElementById('admin-product-description').value.trim();

      if (!name || isNaN(points) || isNaN(quantity) || !description) {
        showToast('请填写所有字段', 'error');
        return;
      }

      if (points <= 0 || quantity < 0) {
        showToast('积分必须大于0，数量必须大于等于0', 'error');
        return;
      }

      const newProduct = {
        id: db.products.length > 0 ? Math.max(...db.products.map(p => p.id)) + 1 : 1,
        name,
        points,
        quantity,
        description
      };

      db.products.push(newProduct);
      saveDB();
      showToast('商品已添加', 'success');
      navigateTo('adminProductList');
    }

    function handleAdminEditProduct(productId) {
      const productIndex = db.products.findIndex(p => p.id === productId);
      if (productIndex === -1) return;

      const name = document.getElementById('admin-product-name').value.trim();
      const points = parseInt(document.getElementById('admin-product-points').value, 10);
      const quantity = parseInt(document.getElementById('admin-product-quantity').value, 10);
      const description = document.getElementById('admin-product-description').value.trim();

      if (!name || isNaN(points) || isNaN(quantity) || !description) {
        showToast('请填写所有字段', 'error');
        return;
      }

      if (points <= 0 || quantity < 0) {
        showToast('积分必须大于0，数量必须大于等于0', 'error');
        return;
      }

      db.products[productIndex] = {
        ...db.products[productIndex],
        name,
        points,
        quantity,
        description
      };

      saveDB();
      showToast('商品已更新', 'success');
      navigateTo('adminProductList');
    }

    function handleAdminDeleteProduct(productId) {
      if (confirm('确定要删除此商品吗？')) {
        db.products = db.products.filter(p => p.id !== productId);
        saveDB();
        showToast('商品已删除', 'success');
        render();
      }
    }

    // 管理员用户管理功能 - 积分充值
    function handleAdminRechargePoints() {
      if (!state.currentUserForPoints) {
        showToast('未找到指定用户', 'error');
        return;
      }

      const points = parseInt(document.getElementById('recharge-points').value, 10);
      const reason = document.getElementById('recharge-reason').value.trim();

      if (isNaN(points) || points <= 0) {
        showToast('请输入有效的积分数量', 'error');
        return;
      }

      if (!reason) {
        showToast('请填写充值原因', 'error');
        return;
      }

      // 更新用户积分
      const userIndex = db.users.findIndex(user => user.id === state.currentUserForPoints.id);
      if (userIndex !== -1) {
        db.users[userIndex].points += points;
        
        // 记录积分交易
        db.pointsTransactions.push({
          id: db.pointsTransactions.length > 0 ? Math.max(...db.pointsTransactions.map(t => t.id)) + 1 : 1,
          userId: state.currentUserForPoints.id,
          type: 'recharge',
          points: points,
          reason: reason,
          date: new Date().toISOString(),
          operator: state.currentUser.username
        });
        
        saveDB();
        showToast(`已成功为 ${state.currentUserForPoints.name} 充值 ${points} 积分`, 'success');
        state.currentUserForPoints = null;
        navigateTo('adminUserManagement');
      }
    }

    // 管理员用户管理功能 - 删除用户
    function handleAdminDeleteUser(userId) {
      // 防止删除管理员账号
      const user = db.users.find(u => u.id === userId);
      if (user && user.isAdmin) {
        showToast('不能删除管理员账号', 'error');
        return;
      }

      if (confirm('确定要删除此用户吗？此操作不可恢复！')) {
        // 删除用户
        db.users = db.users.filter(u => u.id !== userId);
        
        // 删除相关记录
        db.checkins = db.checkins.filter(c => c.userId !== userId);
        db.passwordRequests = db.passwordRequests.filter(r => r.userId !== userId);
        db.usernameRequests = db.usernameRequests.filter(r => r.userId !== userId);
        db.exchangeRequests = db.exchangeRequests.filter(r => r.userId !== userId);
        db.pointsTransactions = db.pointsTransactions.filter(t => t.userId !== userId);
        
        saveDB();
        showToast('用户已成功删除', 'success');
        render();
      }
    }

    // 显示提示消息
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-500 transform translate-x-full opacity-0 flex items-center`;
      
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-success text-white';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-danger text-white';
          icon = 'fa-times-circle';
          break;
        case 'warning':
          bgColor = 'bg-warning text-white';
          icon = 'fa-exclamation-triangle';
          break;
        case 'info':
        default:
          bgColor = 'bg-primary text-white';
          icon = 'fa-info-circle';
          break;
      }
      
      toast.classList.add(...bgColor.split(' '));
      toast.innerHTML = `
        <i class="fa ${icon} mr-2"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // 显示提示
      setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');
      }, 10);
      
      // 自动隐藏
      setTimeout(() => {
        toast.classList.remove('translate-x-0', 'opacity-100');
        toast.classList.add('translate-x-full', 'opacity-0');
        
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 500);
      }, 3000);
    }

    // 渲染页面
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      
      switch(state.currentPage) {
        case 'login':
          app.appendChild(createLoginPage());
          break;
        case 'register':
          app.appendChild(createRegisterPage());
          break;
        case 'userDashboard':
          app.appendChild(createUserDashboard());
          break;
        case 'changePassword':
          app.appendChild(createChangePasswordPage());
          break;
        case 'changeUsername':  // 新增：用户名修改页面
          app.appendChild(createChangeUsernamePage());
          break;
        case 'adminDashboard':
          app.appendChild(createAdminDashboard());
          break;
        case 'adminRegistrationRequests':
          app.appendChild(createAdminRegistrationRequestsPage());
          break;
        case 'productList':
          app.appendChild(createProductListPage());
          break;
        case 'productDetail':
          app.appendChild(createProductDetailPage());
          break;
        case 'adminProductList':
          app.appendChild(createAdminProductListPage());
          break;
        case 'adminAddProduct':
          app.appendChild(createAdminAddProductPage());
          break;
        case 'adminEditProduct':
          app.appendChild(createAdminEditProductPage());
          break;
        case 'adminChangePassword':
          app.appendChild(createAdminChangePasswordPage());
          break;
        case 'adminChangeUsername':
          app.appendChild(createAdminChangeUsernamePage());
          break;
        case 'adminUserManagement':
          app.appendChild(createAdminUserManagementPage());
          break;
        case 'adminRechargePoints':
          app.appendChild(createAdminRechargePointsPage());
          break;
        default:
          app.appendChild(createLoginPage());
      }
    }

    // 创建登录页面
    function createLoginPage() {
      const container = document.createElement('div');
      container.className = 'min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-secondary/5';
      
      container.innerHTML = `
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-300 hover:shadow-2xl">
          <div class="p-8">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold text-primary mb-2">签到系统</h1>
              <p class="text-gray-500">欢迎登录，开始您的签到之旅</p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-user"></i>
                  </span>
                  <input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入用户名">
                </div>
              </div>
              
              <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="login-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入密码">
                </div>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <button type="button" class="text-sm text-primary hover:text-primary/80 transition-colors" onclick="showToast('请联系管理员重置密码', 'info')">
                    忘记密码?
                  </button>
                </div>
                <div class="flex items-center">
                  <button type="button" class="text-sm text-primary hover:text-primary/80 transition-colors" onclick="toggleAdminLogin()">
                    管理员登录
                  </button>
                </div>
              </div>
              
              <button type="button" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleLogin()">
                登录
              </button>
              
              <div class="flex items-center justify-center">
                <span class="text-gray-500">还没有账号?</span>
                <button type="button" class="ml-2 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('register')">
                  立即注册
                </button>
              </div>
            </div>
          </div>
          
          <div id="admin-login-form" class="hidden p-6 bg-gray-50 border-t border-gray-100">
            <div class="text-center mb-4">
              <h2 class="text-xl font-semibold text-gray-700">管理员登录</h2>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="admin-username" class="block text-sm font-medium text-gray-700 mb-1">管理员账号</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-user-circle"></i>
                  </span>
                  <input type="text" id="admin-username" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入管理员账号">
                </div>
              </div>
              
              <div>
                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">管理员密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="admin-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入管理员密码">
                </div>
              </div>
              
              <button type="button" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleAdminLogin()">
                管理员登录
              </button>
              
              <button type="button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="toggleAdminLogin()">
                  返回普通登录
                </button>
            </div>
          </div>
        </div>
      `;
      
      return container;
    }

    // 切换管理员登录表单显示状态
    function toggleAdminLogin() {
      const adminForm = document.getElementById('admin-login-form');
      adminForm.classList.toggle('hidden');
    }

    // 创建注册页面
    function createRegisterPage() {
      const container = document.createElement('div');
      container.className = 'min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-secondary/5';
      
      container.innerHTML = `
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-300 hover:shadow-2xl">
          <div class="p-8">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold text-primary mb-2">创建账户</h1>
              <p class="text-gray-500">填写以下信息注册新账户，注册需管理员审核</p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">真实姓名</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-id-card"></i>
                  </span>
                  <input type="text" id="register-name" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入真实中文姓名">
                </div>
              </div>
              
              <div>
                <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-user"></i>
                  </span>
                  <input type="text" id="register-username" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入用户名（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">用户名只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="register-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入密码（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">密码只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="register-confirm-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请再次输入密码">
                </div>
              </div>
              
              <button type="button" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleRegister()">
                提交注册请求
              </button>
              
              <div class="flex items-center justify-center">
                <span class="text-gray-500">已有账号?</span>
                <button type="button" class="ml-2 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('login')">
                  返回登录
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return container;
    }

    // 创建用户修改密码页面
    function createChangePasswordPage() {
      if (!state.currentUser) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">修改密码</h2>
              <p class="text-gray-500 mt-1">修改密码需要管理员审核，请耐心等待</p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="old-password" class="block text-sm font-medium text-gray-700 mb-1">旧密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="old-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入旧密码">
                </div>
              </div>
              
              <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="new-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入新密码（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">密码只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="confirm-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请再次输入新密码">
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('userDashboard')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleUserChangePassword()">
                  提交修改请求
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 新增：创建用户修改用户名页面
    function createChangeUsernamePage() {
      if (!state.currentUser) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">修改用户名</h2>
              <p class="text-gray-500 mt-1">修改用户名需要管理员审核，请耐心等待</p>
              <p class="text-gray-500 mt-1">当前用户名: <span class="font-medium">${state.currentUser.username}</span></p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">新用户名</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-user"></i>
                  </span>
                  <input type="text" id="new-username" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入新用户名（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">用户名只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="username-password" class="block text-sm font-medium text-gray-700 mb-1">输入密码确认</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="username-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入当前密码进行确认">
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('userDashboard')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleUserChangeUsername()">
                  提交修改请求
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员修改密码页面
    function createAdminChangePasswordPage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">管理员修改密码</h2>
              <p class="text-gray-500 mt-1">管理员可以直接修改密码，无需审核</p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="admin-old-password" class="block text-sm font-medium text-gray-700 mb-1">旧密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="admin-old-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入旧密码">
                </div>
              </div>
              
              <div>
                <label for="admin-new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="admin-new-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入新密码（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">密码只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="admin-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="admin-confirm-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请再次输入新密码">
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('adminDashboard')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleAdminChangePassword()">
                  确认修改
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员修改用户名页面
    function createAdminChangeUsernamePage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">管理员修改用户名</h2>
              <p class="text-gray-500 mt-1">管理员可以直接修改用户名，无需审核</p>
              <p class="text-gray-500 mt-1">当前用户名: <span class="font-medium">${state.currentUser.username}</span></p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="admin-new-username" class="block text-sm font-medium text-gray-700 mb-1">新用户名</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-user"></i>
                  </span>
                  <input type="text" id="admin-new-username" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入新用户名（只能包含字母和数字）">
                </div>
                <p class="text-xs text-gray-500 mt-1">用户名只能包含大小写字母和数字</p>
              </div>
              
              <div>
                <label for="admin-username-password" class="block text-sm font-medium text-gray-700 mb-1">输入密码确认</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-lock"></i>
                  </span>
                  <input type="password" id="admin-username-password" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入当前密码进行确认">
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('adminDashboard')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleAdminChangeUsername()">
                  确认修改
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建用户仪表盘
    function createUserDashboard() {
      if (!state.currentUser) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 transform transition-all duration-300 hover:shadow-xl">
            <div class="flex flex-col md:flex-row items-center">
              <div class="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mb-4 md:mb-0">
                <i class="fa fa-user text-3xl text-primary"></i>
              </div>
              <div class="ml-0 md:ml-6 text-center md:text-left">
                <h2 class="text-2xl font-bold text-gray-800">${state.currentUser.name} (${state.currentUser.username})</h2>
                <p class="text-gray-600 mt-1">当前积分: <span class="text-primary font-semibold">${state.currentUser.points}</span></p>
                
                <div class="mt-4 flex flex-wrap justify-center md:justify-start gap-3">
                  <button type="button" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleCheckIn()">
                    ${hasCheckedInToday(state.currentUser.id) ? 
                      '<i class="fa fa-check mr-2"></i>今日已签到' : 
                      '<i class="fa fa-calendar-check-o mr-2"></i>每日签到 (+10积分)'
                    }
                  </button>
                  
                  <button type="button" class="px-4 py-2 bg-secondary hover:bg-secondary/90 text-white rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="navigateTo('productList')">
                    <i class="fa fa-shopping-mall mr-2"></i>积分商城
                  </button>
                  
                  <button type="button" class="px-4 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="navigateTo('changePassword')">
                    <i class="fa fa-key mr-2"></i>修改密码
                  </button>
                  
                  <!-- 新增：修改用户名按钮 -->
                  <button type="button" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="navigateTo('changeUsername')">
                    <i class="fa fa-user-circle mr-2"></i>修改用户名
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <h2 class="text-xl font-bold text-gray-800 mb-6">最近签到记录</h2>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">积分</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${db.checkins
                    .filter(checkin => checkin.userId === state.currentUser.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5)
                    .map(checkin => `
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${checkin.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary">+10</td>
                      </tr>
                    `)
                    .join('') || `
                      <tr>
                        <td colspan="2" class="px-6 py-4 text-center text-gray-500">暂无签到记录</td>
                      </tr>
                    `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员注册请求审核页面
    function createAdminRegistrationRequestsPage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800">用户注册请求审核</h2>
              <button type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all duration-300" onclick="navigateTo('adminDashboard')">
                <i class="fa fa-arrow-left mr-2"></i>返回
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${db.registrationRequests
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .map(request => `
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(request.createdAt).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            request.status === 'approved' ? 'bg-green-100 text-green-800' : 
                            'bg-red-100 text-red-800'
                          }">
                            ${request.status === 'pending' ? '待审核' : 
                              request.status === 'approved' ? '已批准' : '已拒绝'}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                          ${request.status === 'pending' ? `
                            <button type="button" class="text-green-600 hover:text-green-900 mr-3" onclick="handleAdminApproveRegistration(${request.id})">
                              批准
                            </button>
                            <button type="button" class="text-red-600 hover:text-red-900" onclick="handleAdminRejectRegistration(${request.id})">
                              拒绝
                            </button>
                          ` : ''}
                        </td>
                      </tr>
                    `)
                    .join('') || `
                      <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无注册请求</td>
                      </tr>
                    `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员用户管理页面
    function createAdminUserManagementPage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800">用户管理</h2>
              <button type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all duration-300" onclick="navigateTo('adminDashboard')">
                <i class="fa fa-arrow-left mr-2"></i>返回
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">积分</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${db.users
                    .filter(user => !user.isAdmin) // 只显示普通用户
                    .sort((a, b) => a.id - b.id)
                    .map(user => `
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.points}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            user.status === 'approved' ? 'bg-green-100 text-green-800' : 
                            'bg-red-100 text-red-800'
                          }">
                            ${user.status === 'approved' ? '已激活' : '已禁用'}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                          <button type="button" class="text-primary hover:text-primary/80 mr-3" onclick="state.currentUserForPoints = db.users.find(u => u.id === ${user.id}); navigateTo('adminRechargePoints')">
                            充值积分
                          </button>
                          <button type="button" class="text-danger hover:text-danger/80" onclick="handleAdminDeleteUser(${user.id})">
                            删除账号
                          </button>
                        </td>
                      </tr>
                    `)
                    .join('') || `
                      <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">暂无普通用户</td>
                      </tr>
                    `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员积分充值页面
    function createAdminRechargePointsPage() {
      if (!state.currentUser || !state.currentUser.isAdmin || !state.currentUserForPoints) {
        navigateTo('adminUserManagement');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <button type="button" class="mb-6 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('adminUserManagement')">
            <i class="fa fa-arrow-left mr-1"></i> 返回用户管理
          </button>
          
          <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">积分充值</h2>
              <p class="text-gray-600 mt-2">用户信息: ${state.currentUserForPoints.name} (${state.currentUserForPoints.username})</p>
              <p class="text-gray-600">当前积分: <span class="text-primary font-semibold">${state.currentUserForPoints.points}</span></p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="recharge-points" class="block text-sm font-medium text-gray-700 mb-1">充值积分数量</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fa fa-diamond"></i>
                  </span>
                  <input type="number" id="recharge-points" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入要充值的积分数量" min="1">
                </div>
                <p class="text-xs text-gray-500 mt-1">积分数量必须大于0</p>
              </div>
              
              <div>
                <label for="recharge-reason" class="block text-sm font-medium text-gray-700 mb-1">充值原因</label>
                <textarea id="recharge-reason" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请填写充值原因（如活动奖励、补偿等）"></textarea>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('adminUserManagement')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleAdminRechargePoints()">
                  确认充值
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员仪表盘
    function createAdminDashboard() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">用户总数</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.users.filter(user => !user.isAdmin).length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-users text-xl text-primary"></i>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">商品总数</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.products.length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
                  <i class="fa fa-shopping-bag text-xl text-secondary"></i>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">待处理注册请求</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.registrationRequests.filter(req => req.status === 'pending').length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                  <i class="fa fa-user-plus text-xl text-purple-600"></i>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">待处理密码请求</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.passwordRequests.filter(req => req.status === 'pending').length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center">
                  <i class="fa fa-key text-xl text-warning"></i>
                </div>
              </div>
            </div>
            
            <!-- 新增：待处理用户名修改请求卡片 -->
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">待处理用户名请求</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.usernameRequests.filter(req => req.status === 'pending').length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                  <i class="fa fa-user-circle text-xl text-blue-600"></i>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">待处理兑换请求</p>
                  <h3 class="text-2xl font-bold text-gray-800 mt-1">${db.exchangeRequests.filter(req => req.status === 'pending').length}</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center">
                  <i class="fa fa-exchange text-xl text-success"></i>
                </div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">待处理注册请求</h2>
                <button type="button" class="text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('adminRegistrationRequests')">
                  查看全部
                </button>
              </div>
              
              <div class="space-y-4">
                ${db.registrationRequests
                  .filter(req => req.status === 'pending')
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 3)
                  .map(request => `
                    <div class="p-4 border border-gray-100 rounded-lg hover:border-primary/30 transition-colors">
                      <div class="flex justify-between items-start">
                        <div>
                          <p class="font-medium">${request.username}</p>
                          <p class="text-sm text-gray-500 mt-1">${request.name}</p>
                          <p class="text-xs text-gray-400 mt-1">${new Date(request.createdAt).toLocaleString()}</p>
                        </div>
                        <div class="flex space-x-2">
                          <button type="button" class="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors" onclick="handleAdminApproveRegistration(${request.id})">
                            <i class="fa fa-check"></i>
                          </button>
                          <button type="button" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors" onclick="handleAdminRejectRegistration(${request.id})">
                            <i class="fa fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  `)
                  .join('') || `
                    <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg">
                      暂无待处理注册请求
                    </div>
                  `}
              </div>
            </div>
            
            <!-- 新增：待处理用户名修改请求面板 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">待处理用户名修改请求</h2>
              </div>
              
              <div class="space-y-4">
                ${db.usernameRequests
                  .filter(req => req.status === 'pending')
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 3)
                  .map(request => {
                    const user = db.users.find(u => u.id === request.userId);
                    return `
                      <div class="p-4 border border-gray-100 rounded-lg hover:border-primary/30 transition-colors">
                        <div class="flex justify-between items-start">
                          <div>
                            <p class="font-medium">${request.oldUsername} → ${request.newUsername}</p>
                            <p class="text-sm text-gray-500 mt-1">用户: ${user ? user.name : '未知用户'}</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(request.createdAt).toLocaleString()}</p>
                          </div>
                          <div class="flex space-x-2">
                            <button type="button" class="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors" onclick="handleAdminApproveUsername(${request.id})">
                              <i class="fa fa-check"></i>
                            </button>
                            <button type="button" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors" onclick="handleAdminRejectUsername(${request.id})">
                              <i class="fa fa-times"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                  })
                  .join('') || `
                    <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg">
                      暂无待处理用户名修改请求
                    </div>
                  `}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">待处理密码修改请求</h2>
              </div>
              
              <div class="space-y-4">
                ${db.passwordRequests
                  .filter(req => req.status === 'pending')
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 3)
                  .map(request => `
                    <div class="p-4 border border-gray-100 rounded-lg hover:border-primary/30 transition-colors">
                      <div class="flex justify-between items-start">
                        <div>
                          <p class="font-medium">${request.username}</p>
                          <p class="text-xs text-gray-400 mt-1">${new Date(request.createdAt).toLocaleString()}</p>
                        </div>
                        <div class="flex space-x-2">
                          <button type="button" class="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors" onclick="handleAdminApprovePassword(${request.id})">
                            <i class="fa fa-check"></i>
                          </button>
                          <button type="button" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors" onclick="handleAdminRejectPassword(${request.id})">
                            <i class="fa fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  `)
                  .join('') || `
                    <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg">
                      暂无待处理密码修改请求
                    </div>
                  `}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">待处理兑换请求</h2>
              </div>
              
              <div class="space-y-4">
                ${db.exchangeRequests
                  .filter(req => req.status === 'pending')
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 3)
                  .map(request => {
                    const user = db.users.find(u => u.id === request.userId);
                    const product = db.products.find(p => p.id === request.productId);
                    return `
                      <div class="p-4 border border-gray-100 rounded-lg hover:border-primary/30 transition-colors">
                        <div class="flex justify-between items-start">
                          <div>
                            <p class="font-medium">${user ? user.username : '未知用户'}</p>
                            <p class="text-sm text-gray-500 mt-1">兑换: ${product ? product.name : '未知商品'}</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(request.createdAt).toLocaleString()}</p>
                          </div>
                          <div class="flex space-x-2">
                            <button type="button" class="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors" onclick="handleAdminApproveExchange(${request.id})">
                              <i class="fa fa-check"></i>
                            </button>
                            <button type="button" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors" onclick="handleAdminRejectExchange(${request.id})">
                              <i class="fa fa-times"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                  })
                  .join('') || `
                    <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg">
                      暂无待处理兑换请求
                    </div>
                  `}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl lg:col-span-2">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">管理员操作</h2>
              </div>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button type="button" class="flex flex-col items-center justify-center p-6 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-all duration-300" onclick="navigateTo('adminProductList')">
                  <i class="fa fa-shopping-bag text-2xl text-primary mb-2"></i>
                  <span class="font-medium">商品管理</span>
                </button>
                
                <button type="button" class="flex flex-col items-center justify-center p-6 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-all duration-300" onclick="navigateTo('adminRegistrationRequests')">
                  <i class="fa fa-user-plus text-2xl text-primary mb-2"></i>
                  <span class="font-medium">注册审核</span>
                </button>
                
                <button type="button" class="flex flex-col items-center justify-center p-6 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-all duration-300" onclick="navigateTo('adminChangePassword')">
                  <i class="fa fa-key text-2xl text-primary mb-2"></i>
                  <span class="font-medium">修改密码</span>
                </button>
                
                <button type="button" class="flex flex-col items-center justify-center p-6 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-all duration-300" onclick="navigateTo('adminChangeUsername')">
                  <i class="fa fa-user text-2xl text-primary mb-2"></i>
                  <span class="font-medium">修改用户名</span>
                </button>
                
                <button type="button" class="flex flex-col items-center justify-center p-6 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-all duration-300 col-span-1 sm:col-span-2">
                  <i class="fa fa-users text-2xl text-primary mb-2"></i>
                  <span class="font-medium">用户管理</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建商品列表页面
    function createProductListPage() {
      if (!state.currentUser) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800">积分商城</h2>
            <p class="text-gray-600">当前积分: <span class="text-primary font-semibold">${state.currentUser.points}</span></p>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            ${db.products.map(product => `
              <div class="bg-white rounded-xl shadow-md overflow-hidden transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div class="h-48 bg-gray-100 flex items-center justify-center">
                  <i class="fa fa-shopping-bag text-5xl text-gray-300"></i>
                </div>
                <div class="p-5">
                  <h3 class="font-bold text-lg text-gray-800 mb-2">${product.name}</h3>
                  <p class="text-gray-500 text-sm mb-3 line-clamp-2">${product.description}</p>
                  <div class="flex justify-between items-center">
                    <span class="text-primary font-bold">${product.points} 积分</span>
                    <span class="text-xs ${product.quantity > 0 ? 'text-success' : 'text-danger'}">
                      ${product.quantity > 0 ? `库存: ${product.quantity}` : '已售罄'}
                    </span>
                  </div>
                  <button type="button" class="w-full mt-4 bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-all duration-300 ${product.quantity <= 0 || state.currentUser.points < product.points ? 'opacity-50 cursor-not-allowed' : ''}" 
                    onclick="${product.quantity > 0 && state.currentUser.points >= product.points ? `handleExchangeProduct(${product.id})` : ''}">
                    兑换商品
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建商品详情页面
    function createProductDetailPage() {
      if (!state.currentProduct) {
        navigateTo('productList');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <button type="button" class="mb-6 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('productList')">
            <i class="fa fa-arrow-left mr-1"></i> 返回商品列表
          </button>
          
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-2">
              <div class="bg-gray-100 p-8 flex items-center justify-center">
                <i class="fa fa-shopping-bag text-8xl text-gray-300"></i>
              </div>
              <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">${state.currentProduct.name}</h2>
                <div class="flex items-center mb-4">
                  <span class="text-2xl font-bold text-primary">${state.currentProduct.points} 积分</span>
                  <span class="ml-4 text-sm ${state.currentProduct.quantity > 0 ? 'text-success' : 'text-danger'}">
                    ${state.currentProduct.quantity > 0 ? `库存: ${state.currentProduct.quantity}` : '已售罄'}
                  </span>
                </div>
                <div class="mb-6">
                  <h3 class="text-sm font-medium text-gray-500 mb-2">商品描述</h3>
                  <p class="text-gray-600">${state.currentProduct.description}</p>
                </div>
                <button type="button" class="w-full py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300 ${state.currentProduct.quantity <= 0 || (state.currentUser && state.currentUser.points < state.currentProduct.points) ? 'opacity-50 cursor-not-allowed' : ''}" 
                  onclick="${state.currentProduct.quantity > 0 && state.currentUser && state.currentUser.points >= state.currentProduct.points ? `handleExchangeProduct(${state.currentProduct.id})` : ''}">
                  兑换商品
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员商品列表页面
    function createAdminProductListPage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800">商品管理</h2>
            <button type="button" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300 btn-hover" onclick="navigateTo('adminAddProduct')">
              <i class="fa fa-plus mr-2"></i>添加商品
            </button>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品名称</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所需积分</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">库存数量</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${db.products.map(product => `
                    <tr class="hover:bg-gray-50 transition-colors">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${product.name}</div>
                        <div class="text-sm text-gray-500 mt-1 line-clamp-2 w-64">${product.description}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.points}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.quantity}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button type="button" class="text-primary hover:text-primary/80 mr-3" onclick="state.currentProduct = db.products.find(p => p.id === ${product.id}); navigateTo('adminEditProduct')">
                          编辑
                        </button>
                        <button type="button" class="text-danger hover:text-danger/80" onclick="handleAdminDeleteProduct(${product.id})">
                          删除
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员添加商品页面
    function createAdminAddProductPage() {
      if (!state.currentUser || !state.currentUser.isAdmin) {
        navigateTo('login');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <button type="button" class="mb-6 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('adminProductList')">
            <i class="fa fa-arrow-left mr-1"></i> 返回商品列表
          </button>
          
          <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">添加新商品</h2>
            
            <div class="space-y-4">
              <div>
                <label for="admin-product-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                <input type="text" id="admin-product-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入商品名称">
              </div>
              
              <div>
                <label for="admin-product-points" class="block text-sm font-medium text-gray-700 mb-1">所需积分</label>
                <input type="number" id="admin-product-points" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入所需积分" min="1">
              </div>
              
              <div>
                <label for="admin-product-quantity" class="block text-sm font-medium text-gray-700 mb-1">库存数量</label>
                <input type="number" id="admin-product-quantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入库存数量" min="0">
              </div>
              
              <div>
                <label for="admin-product-description" class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
                <textarea id="admin-product-description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" placeholder="请输入商品描述"></textarea>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300" onclick="navigateTo('adminProductList')">
                  取消
                </button>
                <button type="button" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] btn-hover" onclick="handleAdminAddProduct()">
                  添加商品
                </button>
              </div>
            </div>
          </div>
        </div>
        
        ${createFooter()}
      `;
      
      return container;
    }

    // 创建管理员编辑商品页面
    function createAdminEditProductPage() {
      if (!state.currentUser || !state.currentUser.isAdmin || !state.currentProduct) {
        navigateTo('adminProductList');
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'min-h-screen bg-gray-50 flex flex-col';
      
      container.innerHTML = `
        ${createHeader()}
        
        <div class="flex-grow container mx-auto px-4 py-8">
          <button type="button" class="mb-6 text-primary hover:text-primary/80 transition-colors" onclick="navigateTo('adminProductList')">
            <i class="fa fa-arrow-left mr-1"></i> 返回商品列表
          </button>
          
          <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">编辑商品</h2>
            
            <div class="space-y-4">
              <div>
                <label for="admin-product-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                <input type="text" id="admin-product-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" value="${state.currentProduct.name}">
              </div>
              
              <div>
                <label for="admin-product-points" class="block text-sm font-medium text-gray-700 mb-1">所需积分</label>
                <input type="number" id="admin-product-points" class="w-full px-4 py-2 border border-gray-300 rounded-lg form-input-focus" value="${state.currentProduct.points}" min="1">
              </div>
              
              <div>
                <label for="admin-product-quantity" class="block text-sm font-medium text-gray-700