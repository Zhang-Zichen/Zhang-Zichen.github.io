const express = require('express');
const bodyParser = require('body-parser');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// 管理员密码（实际应用中应使用加密存储）
const ADMIN_PASSWORD = 'admin123'; // 可自行修改

// 配置存储
const storageDir = path.join(__dirname, 'storage');
const imagesDir = path.join(storageDir, 'images');
const contentPath = path.join(storageDir, 'content.json');

// 确保存储目录存在
if (!fs.existsSync(storageDir)) {
  fs.mkdirSync(storageDir);
}

if (!fs.existsSync(imagesDir)) {
  fs.mkdirSync(imagesDir);
}

// 默认内容
const defaultContent = {
  title: '欢迎来到宁波市樱花公园站信息页',
  content: '樱花公园站是宁波市地铁1号线和3号线的换乘站，交通便利，周边设施完善。',
  image: null
};

// 如果内容文件不存在，创建默认内容
if (!fs.existsSync(contentPath)) {
  fs.writeFileSync(contentPath, JSON.stringify(defaultContent, null, 2));
}

// 配置multer用于文件上传
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, imagesDir);
  },
  filename: (req, file, cb) => {
    // 生成唯一文件名
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);
    const ext = path.extname(file.originalname);
    cb(null, 'image-' + uniqueSuffix + ext);
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 限制5MB
  },
  fileFilter: (req, file, cb) => {
    // 只接受图片文件
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('只允许上传图片文件'));
    }
  }
});

// 中间件
app.use(cors());
app.use(bodyParser.json());
app.use('/images', express.static(imagesDir));
app.use(express.static(path.join(__dirname, '.')));

// 管理员登录API
app.post('/api/admin/login', (req, res) => {
  const { password } = req.body;
  
  if (password === ADMIN_PASSWORD) {
    res.json({ success: true });
  } else {
    res.json({ success: false, message: '密码不正确' });
  }
});

// 获取主页内容API
app.get('/api/content', (req, res) => {
  try {
    const content = JSON.parse(fs.readFileSync(contentPath, 'utf8'));
    res.json(content);
  } catch (error) {
    console.error('获取内容错误:', error);
    res.json(defaultContent);
  }
});

// 保存主页内容API
app.post('/api/content', upload.single('image'), (req, res) => {
  try {
    const existingContent = JSON.parse(fs.readFileSync(contentPath, 'utf8'));
    const updatedContent = {
      title: req.body.title || existingContent.title,
      content: req.body.content || existingContent.content,
      image: existingContent.image // 默认使用现有图片
    };
    
    // 如果有新图片上传，更新图片路径
    if (req.file) {
      // 删除旧图片（如果存在）
      if (existingContent.image) {
        const oldImagePath = path.join(imagesDir, path.basename(existingContent.image));
        if (fs.existsSync(oldImagePath)) {
          fs.unlinkSync(oldImagePath);
        }
      }
      
      // 设置新图片路径
      updatedContent.image = `/images/${req.file.filename}`;
    }
    
    // 保存更新后的内容
    fs.writeFileSync(contentPath, JSON.stringify(updatedContent, null, 2));
    res.json({ success: true });
  } catch (error) {
    console.error('保存内容错误:', error);
    res.status(500).json({ success: false, message: '保存内容失败' });
  }
});

// 启动服务器
app.listen(PORT, () => {
  console.log(`服务器运行在 http://localhost:${PORT}`);
  console.log(`管理员密码: ${ADMIN_PASSWORD}`);
});
